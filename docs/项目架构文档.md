# Go-Agent (Lattice) é¡¹ç›®æ¶æ„æ–‡æ¡£

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ•´ä½“æ¶æ„è®¾è®¡](#æ•´ä½“æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒæ¨¡å—è¯¦è§£](#æ ¸å¿ƒæ¨¡å—è¯¦è§£)
4. [æ¨¡å—é—´åä½œå…³ç³»](#æ¨¡å—é—´åä½œå…³ç³»)
5. [å…³é”®æµç¨‹åˆ†æ](#å…³é”®æµç¨‹åˆ†æ)
6. [æŠ€æœ¯æ ˆä¸ä¾èµ–](#æŠ€æœ¯æ ˆä¸ä¾èµ–)

---

## é¡¹ç›®æ¦‚è¿°

### ç®€ä»‹

**Go-Agent (Lattice)** æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€æ„å»ºçš„ AI æ™ºèƒ½ä»£ç†ï¼ˆAgentï¼‰æ¡†æ¶ï¼Œæ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›æ¸…æ™°çš„æŠ½è±¡å±‚ï¼Œç®€åŒ–å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ã€å·¥å…·è°ƒç”¨ã€æ£€ç´¢å¢å¼ºè®°å¿†ï¼ˆRAGï¼‰ä»¥åŠå¤šæ™ºèƒ½ä½“ååŒç­‰åŠŸèƒ½çš„å®ç°ã€‚è¯¥æ¡†æ¶ä¸“æ³¨äºç”Ÿäº§çº§åº”ç”¨ï¼Œæä¾›å¯æ’æ‹”çš„ç»„ä»¶å’Œæ¨¡å—åŒ–æ¶æ„ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **ğŸ§© æ¨¡å—åŒ–æ¶æ„**ï¼šé€šè¿‡å¯å¤ç”¨æ¨¡å—ä»¥å£°æ˜å¼é…ç½®æ„å»ºæ™ºèƒ½ä½“
- **ğŸ¤– å¤šæ™ºèƒ½ä½“æ”¯æŒ**ï¼šé€šè¿‡å…±äº«ç›®å½•å’Œä»£ç†ç³»ç»Ÿåè°ƒä¸“ä¸šåŒ–æ™ºèƒ½ä½“
- **ğŸ”§ ä¸°å¯Œçš„å·¥å…·ç³»ç»Ÿ**ï¼šä¸€æ¬¡å®ç° `Tool` æ¥å£ï¼Œå¤„å¤„è‡ªåŠ¨ä½¿ç”¨
- **ğŸ§  æ™ºèƒ½è®°å¿†ç³»ç»Ÿ**ï¼šåŸºäº RAG çš„è®°å¿†ï¼Œæ”¯æŒé‡è¦æ€§è¯„åˆ†ã€MMR æ£€ç´¢å’Œè‡ªåŠ¨ä¿®å‰ª
- **ğŸ”Œ æ¨¡å‹æ— å…³æ€§**ï¼šæ”¯æŒ Geminiã€Anthropicã€Ollama ç­‰å¤šç§ LLM æä¾›å•†
- **ğŸ“¡ UTCP æ”¯æŒ**ï¼šä¸€æµçš„é€šç”¨å·¥å…·è°ƒç”¨åè®®ï¼ˆUniversal Tool Calling Protocolï¼‰æ”¯æŒ
- **âš¡ é«˜æ€§èƒ½**ï¼šé€šè¿‡ LRU ç¼“å­˜ã€é¢„åˆ†é…ç¼“å†²åŒºå’Œå¹¶å‘æ“ä½œä¼˜åŒ–æ€§èƒ½

### è®¾è®¡ç†å¿µ

1. **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šå°†æ¨¡å‹è°ƒç”¨ã€è®°å¿†ç®¡ç†ã€å·¥å…·ç¼–æ’ã€å­æ™ºèƒ½ä½“ååŒç­‰èŒè´£æ¸…æ™°åˆ†ç¦»
2. **æ¥å£æŠ½è±¡**ï¼šé€šè¿‡æ¥å£å®šä¹‰æ ¸å¿ƒç»„ä»¶ï¼Œå®ç°å¯æ›¿æ¢æ€§å’Œå¯æµ‹è¯•æ€§
3. **ç”Ÿäº§å°±ç»ª**ï¼šå†…ç½®æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å¤„ç†ã€å¹¶å‘å®‰å…¨ç­‰ç”Ÿäº§çº§ç‰¹æ€§
4. **å¼€å‘è€…å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„ APIã€ä¸°å¯Œçš„ç¤ºä¾‹å’Œè¯¦ç»†çš„æ–‡æ¡£

---

## æ•´ä½“æ¶æ„è®¾è®¡

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ (Application)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  CLI Demo  â”‚  â”‚ Multi-Agentâ”‚  â”‚  CodeMode  â”‚  ...       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒå±‚ (Core Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Agent (æ™ºèƒ½ä½“æ ¸å¿ƒ)                        â”‚   â”‚
â”‚  â”‚  â€¢ åè°ƒæ¨¡å‹ã€è®°å¿†ã€å·¥å…·å’Œå­æ™ºèƒ½ä½“                      â”‚   â”‚
â”‚  â”‚  â€¢ ç®¡ç†å¯¹è¯æµç¨‹å’Œä¸Šä¸‹æ–‡                               â”‚   â”‚
â”‚  â”‚  â€¢ æ”¯æŒ Checkpoint/Restore çŠ¶æ€æŒä¹…åŒ–                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         ADK (Agent Development Kit)                   â”‚   â”‚
â”‚  â”‚  â€¢ æ¨¡å—åŒ–ä¾èµ–æ³¨å…¥å®¹å™¨                                 â”‚   â”‚
â”‚  â”‚  â€¢ æä¾›å£°æ˜å¼é…ç½®æ–¹å¼                                 â”‚   â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€çš„ Provider æ¨¡å¼                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service Layer)                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Models    â”‚  â”‚   Memory    â”‚  â”‚    Tools    â”‚         â”‚
â”‚  â”‚  (æ¨¡å‹æŠ½è±¡)  â”‚  â”‚  (è®°å¿†ç³»ç»Ÿ)  â”‚  â”‚  (å·¥å…·ç³»ç»Ÿ)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  SubAgents  â”‚  â”‚    Swarm    â”‚  â”‚    Cache    â”‚         â”‚
â”‚  â”‚ (å­æ™ºèƒ½ä½“)   â”‚  â”‚  (ç¾¤ä½“ååŒ)  â”‚  â”‚  (ç¼“å­˜å±‚)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Vector Store â”‚  â”‚  Embedder   â”‚  â”‚Concurrent   â”‚         â”‚
â”‚  â”‚(å‘é‡å­˜å‚¨)    â”‚  â”‚ (åµŒå…¥æ¨¡å‹)   â”‚  â”‚ (å¹¶å‘å·¥å…·)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  æ”¯æŒ: PostgreSQL, Qdrant, Neo4j, MongoDB, InMemory        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡æ¨¡å¼

1. **æ¥å£é©±åŠ¨è®¾è®¡**ï¼š
   - `models.Agent`ï¼šç»Ÿä¸€çš„ LLM æ¥å£
   - `Tool`ï¼šå·¥å…·çš„æ ‡å‡†æ¥å£
   - `SubAgent`ï¼šå­æ™ºèƒ½ä½“æ¥å£
   - `VectorStore`ï¼šå‘é‡å­˜å‚¨æ¥å£

2. **Provider æ¨¡å¼**ï¼š
   - `ModelProvider`ï¼šæä¾›æ¨¡å‹å®ä¾‹
   - `MemoryProvider`ï¼šæä¾›è®°å¿†å®ä¾‹
   - `ToolProvider`ï¼šæä¾›å·¥å…·é›†åˆ

3. **Module æ¨¡å¼**ï¼š
   - ADK çš„æ ¸å¿ƒæ¨¡å¼ï¼Œé€šè¿‡ `Module` æ¥å£å®ç°å¯æ’æ‹”ç»„ä»¶
   - æ”¯æŒå£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åˆå§‹åŒ–

4. **Catalog æ¨¡å¼**ï¼š
   - `ToolCatalog`ï¼šç®¡ç†å·¥å…·æ³¨å†Œå’ŒæŸ¥æ‰¾
   - `SubAgentDirectory`ï¼šç®¡ç†å­æ™ºèƒ½ä½“æ³¨å†Œå’ŒæŸ¥æ‰¾

---

## æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 1. Agent æ¨¡å— (æ ¸å¿ƒå±‚)

**ä½ç½®**: `agent.go`, `types.go`, `agent_*.go`

#### èŒè´£

Agent æ˜¯æ•´ä¸ªæ¡†æ¶çš„æ ¸å¿ƒåè°ƒå™¨ï¼Œè´Ÿè´£ï¼š
- åè°ƒ LLM è°ƒç”¨
- ç®¡ç†å¯¹è¯ä¸Šä¸‹æ–‡å’Œè®°å¿†
- ç¼–æ’å·¥å…·è°ƒç”¨å’Œå­æ™ºèƒ½ä½“å§”æ´¾
- æ”¯æŒ UTCP å·¥å…·è°ƒç”¨åè®®
- æä¾›çŠ¶æ€æ£€æŸ¥ç‚¹å’Œæ¢å¤åŠŸèƒ½

#### æ ¸å¿ƒç»“æ„

```go
type Agent struct {
    model        models.Agent          // åº•å±‚ LLM æ¨¡å‹
    memory       *memory.SessionMemory // ä¼šè¯è®°å¿†
    systemPrompt string                // ç³»ç»Ÿæç¤ºè¯
    contextLimit int                   // ä¸Šä¸‹æ–‡é™åˆ¶
    
    toolCatalog       ToolCatalog         // å·¥å…·ç›®å½•
    subAgentDirectory SubAgentDirectory   // å­æ™ºèƒ½ä½“ç›®å½•
    UTCPClient        utcp.UtcpClientInterface // UTCP å®¢æˆ·ç«¯
    
    Shared    *memory.SharedSession      // å…±äº«ä¼šè¯
    CodeMode  *codemode.CodeModeUTCP     // CodeMode æ”¯æŒ
    CodeChain *chain.UtcpChainClient     // é“¾å¼å·¥å…·è°ƒç”¨
}
```

#### å…³é”®æ–¹æ³•

1. **`New(opts Options) (*Agent, error)`**
   - åˆ›å»ºæ–°çš„æ™ºèƒ½ä½“å®ä¾‹
   - éªŒè¯å¿…éœ€çš„ç»„ä»¶ï¼ˆModel å’Œ Memoryï¼‰
   - åˆå§‹åŒ–å·¥å…·ç›®å½•å’Œå­æ™ºèƒ½ä½“ç›®å½•

2. **`Generate(ctx context.Context, sessionID, prompt string) (string, error)`**
   - æ ¸å¿ƒå¯¹è¯ç”Ÿæˆæ–¹æ³•
   - å¤„ç†è®°å¿†æ£€ç´¢ã€ä¸Šä¸‹æ–‡æ„å»ºã€å·¥å…·è°ƒç”¨
   - æ”¯æŒå¤šè½®å¯¹è¯å’Œæµå¼è¾“å‡º

3. **`RegisterAsUTCPProvider(ctx, client, name, desc string) error`**
   - å°† Agent è‡ªèº«æ³¨å†Œä¸º UTCP å·¥å…·
   - æ”¯æŒæ™ºèƒ½ä½“é—´é€šä¿¡å’Œå±‚çº§æ¶æ„

4. **`Checkpoint() ([]byte, error)` / `Restore(data []byte) error`**
   - çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤
   - ä¿å­˜/æ¢å¤ä¼šè¯è®°å¿†å’Œå…±äº«ç©ºé—´æˆå‘˜å…³ç³»

#### å·¥ä½œæµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
æ£€ç´¢ç›¸å…³è®°å¿† (RAG)
    â†“
æ„å»ºä¸Šä¸‹æ–‡ (ç³»ç»Ÿæç¤ºè¯ + è®°å¿† + ç”¨æˆ·è¾“å…¥ + å·¥å…·å®šä¹‰)
    â†“
LLM ç”Ÿæˆå“åº”
    â†“
è§£æå·¥å…·è°ƒç”¨è¯·æ±‚ â† éœ€è¦å·¥å…·?
    â†“                    â†“ å¦
æ‰§è¡Œå·¥å…·/å­æ™ºèƒ½ä½“      ç›´æ¥è¿”å›å“åº”
    â†“
åˆå¹¶å·¥å…·ç»“æœ
    â†“
å­˜å‚¨åˆ°è®°å¿†
    â†“
è¿”å›æœ€ç»ˆå“åº”
```

---

### 2. ADK æ¨¡å— (Agent Development Kit)

**ä½ç½®**: `src/adk/`

#### èŒè´£

ADK æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ä¾èµ–æ³¨å…¥å®¹å™¨å’Œé…ç½®ç³»ç»Ÿï¼Œç”¨äºï¼š
- æ¨¡å—åŒ–ç»„è£…æ™ºèƒ½ä½“ç»„ä»¶
- æä¾›å£°æ˜å¼é…ç½®æ–¹å¼
- ç»Ÿä¸€ç®¡ç† Provider ç”Ÿå‘½å‘¨æœŸ
- æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼

#### æ ¸å¿ƒç»“æ„

```go
type AgentDevelopmentKit struct {
    modules      []Module              // æ³¨å†Œçš„æ¨¡å—åˆ—è¡¨
    bootstrapped bool                  // æ˜¯å¦å·²åˆå§‹åŒ–
    
    modelProvider    ModelProvider     // æ¨¡å‹æä¾›è€…
    memoryProvider   MemoryProvider    // è®°å¿†æä¾›è€…
    toolProviders    []ToolProvider    // å·¥å…·æä¾›è€…åˆ—è¡¨
    subAgentProvider []SubAgentProvider // å­æ™ºèƒ½ä½“æä¾›è€…
    
    UTCP      utcp.UtcpClientInterface
    CodeMode  *codemode.CodeModeUTCP
    ChainMode *chain.UtcpChainClient
}
```

#### Module æ¥å£

```go
type Module interface {
    Name() string
    Provision(ctx context.Context, kit *AgentDevelopmentKit) error
}
```

#### å†…ç½®æ¨¡å—

1. **ModelModule** (`src/adk/modules/model_module.go`)
   - æä¾› LLM æ¨¡å‹å®ä¾‹
   - æ”¯æŒæ‡’åŠ è½½å’Œå·¥å‚æ¨¡å¼

2. **MemoryModule** (`src/adk/modules/memory_module.go`)
   - æä¾›è®°å¿†ç³»ç»Ÿé…ç½®
   - æ”¯æŒå¤šç§å‘é‡å­˜å‚¨åç«¯ï¼ˆInMemory, Qdrant, PostgreSQLï¼‰

3. **ToolModule** (`src/adk/modules/tool_module.go`)
   - æ³¨å†Œå·¥å…·é›†åˆ
   - æ”¯æŒé™æ€å·¥å…·å’ŒåŠ¨æ€å·¥å…·

4. **SubAgentModule** (`src/adk/modules/subagent_module.go`)
   - æ³¨å†Œå­æ™ºèƒ½ä½“
   - æ”¯æŒä¸“ä¸šåŒ–æ™ºèƒ½ä½“ç»„è£…

#### ä½¿ç”¨ç¤ºä¾‹

```go
kit, err := adk.New(ctx,
    adk.WithDefaultSystemPrompt("You are a helpful assistant."),
    adk.WithModules(
        adkmodules.NewModelModule("gemini", func(ctx context.Context) (models.Agent, error) {
            return models.NewGeminiLLM(ctx, "gemini-2.5-pro", "prefix:")
        }),
        adkmodules.InMemoryMemory(100000, memory.AutoEmbedder()),
    ),
    adk.WithSubAgents(subagents.NewResearcher(researcherModel)),
)

agent, err := kit.BuildAgent(ctx)
```

---

### 3. Memory æ¨¡å— (è®°å¿†ç³»ç»Ÿ)

**ä½ç½®**: `src/memory/`

#### æ¶æ„åˆ†å±‚

```
SessionMemory (ä¼šè¯å±‚)
    â†“
MemoryBank (ç®¡ç†å±‚)
    â†“
Engine (å¼•æ“å±‚)
    â†“
VectorStore (å­˜å‚¨å±‚)
```

#### æ ¸å¿ƒç»„ä»¶

##### 3.1 Engine (å¼•æ“å±‚)

**æ–‡ä»¶**: `src/memory/engine/engine.go`

**èŒè´£**ï¼š
- è®°å¿†çš„è¯„åˆ†ã€èšç±»ã€ä¿®å‰ªå’Œæ£€ç´¢
- è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—
- é‡è¦æ€§è¯„åˆ†
- å»é‡å’Œæ‘˜è¦ç”Ÿæˆ

**å…³é”®ç®—æ³•**ï¼š

1. **é‡è¦æ€§è¯„åˆ†** (`importanceScore`)
   ```go
   // åŸºäºå†…å®¹é•¿åº¦ã€å®ä½“å¯†åº¦ã€å…³é”®è¯ç­‰è®¡ç®—é‡è¦æ€§
   score = baseScore * lengthFactor * entityDensity * keywordBonus
   ```

2. **MMR æ£€ç´¢** (Maximum Marginal Relevance)
   ```go
   // å¹³è¡¡ç›¸å…³æ€§å’Œå¤šæ ·æ€§
   MMR(D, q) = argmax[Î» * Sim(D, q) - (1-Î») * max Sim(D, d_i)]
   ```

3. **æ—¶é—´è¡°å‡**
   ```go
   // æ ¹æ®æ—¶é—´é™ä½æ—§è®°å¿†çš„æƒé‡
   decayedScore = originalScore * exp(-decay * timeDelta)
   ```

**ä¸»è¦æ–¹æ³•**ï¼š
- `Store(ctx, sessionID, content, metadata)`: å­˜å‚¨æ–°è®°å¿†
- `Retrieve(ctx, sessionID, query, limit)`: æ£€ç´¢ç›¸å…³è®°å¿†
- `Prune(ctx, sessionID, strategy)`: ä¿®å‰ªä½ä»·å€¼è®°å¿†
- `Summarize(ctx, sessionID, records)`: ç”Ÿæˆè®°å¿†æ‘˜è¦

##### 3.2 SessionMemory (ä¼šè¯å±‚)

**æ–‡ä»¶**: `src/memory/session/spaces.go`

**èŒè´£**ï¼š
- ç®¡ç†ä¼šè¯çº§åˆ«çš„è®°å¿†
- æ”¯æŒçŸ­æœŸå’Œé•¿æœŸè®°å¿†
- æä¾›å…±äº«ç©ºé—´ï¼ˆSharedSpaceï¼‰åŠŸèƒ½

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

1. **çŸ­æœŸè®°å¿†**ï¼š
   - å½“å‰ä¼šè¯çš„ä¸´æ—¶è®°å¿†
   - ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œå¿«é€Ÿè®¿é—®
   - ä¼šè¯ç»“æŸåå¯é€‰æ‹©æ€§æŒä¹…åŒ–

2. **é•¿æœŸè®°å¿†**ï¼š
   - æŒä¹…åŒ–çš„å‘é‡å­˜å‚¨è®°å¿†
   - æ”¯æŒè¯­ä¹‰æ£€ç´¢
   - è·¨ä¼šè¯å…±äº«

3. **å…±äº«ç©ºé—´**ï¼š
   - å¤šä¸ªæ™ºèƒ½ä½“å¯ä»¥åŠ å…¥åŒä¸€ç©ºé—´
   - åœ¨ç©ºé—´å†…å…±äº«è®°å¿†å’Œä¸Šä¸‹æ–‡
   - æ”¯æŒè§’è‰²æƒé™ï¼ˆReader, Writer, Adminï¼‰

##### 3.3 VectorStore (å­˜å‚¨å±‚)

**æ¥å£å®šä¹‰**ï¼š
```go
type VectorStore interface {
    StoreMemory(ctx, sessionID, content string, metadata map[string]any, embedding []float32) error
    SearchMemory(ctx, sessionID string, embedding []float32, limit int) ([]MemoryRecord, error)
    DeleteMemory(ctx, sessionID string, ids []string) error
}
```

**æ”¯æŒçš„å®ç°**ï¼š
- **InMemoryStore**: å†…å­˜å­˜å‚¨ï¼Œé€‚åˆæµ‹è¯•å’Œå°è§„æ¨¡åº”ç”¨
- **PostgresStore**: PostgreSQL + pgvectorï¼Œç”Ÿäº§çº§æŒä¹…åŒ–
- **QdrantStore**: ä¸“ä¸šå‘é‡æ•°æ®åº“ï¼Œé«˜æ€§èƒ½æ£€ç´¢
- **Neo4jStore**: å›¾æ•°æ®åº“ï¼Œæ”¯æŒå…³ç³»å›¾è°±
- **MongoStore**: MongoDBï¼Œçµæ´»çš„æ–‡æ¡£å­˜å‚¨

##### 3.4 Embedder (åµŒå…¥å±‚)

**æ–‡ä»¶**: `src/memory/embed/`

**æ”¯æŒçš„åµŒå…¥æ¨¡å‹**ï¼š
- **OpenAI**: text-embedding-ada-002
- **Gemini**: text-embedding-004
- **Ollama**: æœ¬åœ°éƒ¨ç½²æ¨¡å‹
- **FastEmbed**: è½»é‡çº§åµŒå…¥
- **Claude**: Anthropic åµŒå…¥æœåŠ¡
- **Dummy**: æµ‹è¯•ç”¨éšæœºå‘é‡

**è‡ªåŠ¨é€‰æ‹©**ï¼š
```go
embedder := memory.AutoEmbedder()
// æ ¹æ®ç¯å¢ƒå˜é‡è‡ªåŠ¨é€‰æ‹©æœ€ä½³åµŒå…¥æ¨¡å‹
```

---

### 4. Models æ¨¡å— (æ¨¡å‹æŠ½è±¡)

**ä½ç½®**: `src/models/`

#### ç»Ÿä¸€æ¥å£

```go
type Agent interface {
    Generate(ctx context.Context, prompt string) (any, error)
    GenerateWithFiles(ctx context.Context, prompt string, files []File) (any, error)
}
```

#### æ”¯æŒçš„æä¾›å•†

##### 4.1 Gemini (Google)

**æ–‡ä»¶**: `src/models/gemini.go`

**ç‰¹æ€§**ï¼š
- æ”¯æŒ Gemini 1.5/2.5 Pro ç³»åˆ—
- åŸç”Ÿå¤šæ¨¡æ€æ”¯æŒ
- å·¥å…·è°ƒç”¨ï¼ˆFunction Callingï¼‰
- æµå¼è¾“å‡º

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
model, err := models.NewGeminiLLM(ctx, "gemini-2.5-pro", "system prompt")
response, err := model.Generate(ctx, "What is AI?")
```

##### 4.2 Anthropic (Claude)

**æ–‡ä»¶**: `src/models/anthropics.go`

**ç‰¹æ€§**ï¼š
- Claude 3 Opus/Sonnet/Haiku ç³»åˆ—
- å¼ºå¤§çš„æ¨ç†èƒ½åŠ›
- é•¿ä¸Šä¸‹æ–‡æ”¯æŒ (200K tokens)
- å·¥å…·ä½¿ç”¨

##### 4.3 Ollama (æœ¬åœ°éƒ¨ç½²)

**æ–‡ä»¶**: `src/models/ollama.go`

**ç‰¹æ€§**ï¼š
- æœ¬åœ°è¿è¡Œå¼€æºæ¨¡å‹
- æ— éœ€ API å¯†é’¥
- æ”¯æŒ Llama, Mistral, Phi ç­‰æ¨¡å‹
- å®Œå…¨ç§æœ‰åŒ–éƒ¨ç½²

##### 4.4 OpenAI

**æ–‡ä»¶**: `src/models/openai.go`

**ç‰¹æ€§**ï¼š
- GPT-4, GPT-3.5 ç³»åˆ—
- å·¥å…·è°ƒç”¨
- è§†è§‰ç†è§£

##### 4.5 Cached Model

**æ–‡ä»¶**: `src/models/cached.go`

**ç‰¹æ€§**ï¼š
- å¯¹ä»»æ„æ¨¡å‹æ·»åŠ ç¼“å­˜å±‚
- åŸºäº prompt hash ç¼“å­˜ç»“æœ
- å‡å°‘ API è°ƒç”¨æˆæœ¬
- æå‡å“åº”é€Ÿåº¦

---

### 5. Tools æ¨¡å— (å·¥å…·ç³»ç»Ÿ)

**ä½ç½®**: `agent_tool.go`, `catalog.go`

#### å·¥å…·æ¥å£

```go
type Tool interface {
    Spec() ToolSpec
    Invoke(ctx context.Context, req ToolRequest) (ToolResponse, error)
}

type ToolSpec struct {
    Name        string           // å·¥å…·åç§°
    Description string           // å·¥å…·æè¿°
    InputSchema map[string]any   // è¾“å…¥å‚æ•° Schema (JSON Schema)
    Examples    []map[string]any // ä½¿ç”¨ç¤ºä¾‹
}
```

#### å·¥å…·æ³¨å†Œä¸æŸ¥æ‰¾

```go
// é™æ€å·¥å…·ç›®å½•
catalog := agent.NewStaticToolCatalog([]agent.Tool{
    echoTool,
    calculatorTool,
})

// æ³¨å†Œæ–°å·¥å…·
catalog.Register(newTool)

// æŸ¥æ‰¾å·¥å…·
tool, spec, found := catalog.Lookup("echo")

// è·å–æ‰€æœ‰å·¥å…·è§„èŒƒï¼ˆç”¨äºæç¤º LLMï¼‰
specs := catalog.Specs()
```

#### å·¥å…·é€‚é…å™¨

##### SubAgentTool

å°†å­æ™ºèƒ½ä½“åŒ…è£…ä¸ºå·¥å…·ï¼š

```go
type SubAgentTool struct {
    subAgent SubAgent
}

// ä»»ä½• SubAgent éƒ½å¯ä»¥ä½œä¸º Tool ä½¿ç”¨
tool := NewSubAgentTool(researcher)
```

##### AgentToolAdapter

å°†å®Œæ•´ Agent åŒ…è£…ä¸ºå·¥å…·ï¼š

```go
adapter := agent.NewAgentToolAdapter(subAgent, "researcher", "Research specialist")
```

#### UTCP é›†æˆ

**UTCP (Universal Tool Calling Protocol)** æ˜¯ä¸€ä¸ªæ ‡å‡†åŒ–çš„å·¥å…·è°ƒç”¨åè®®ã€‚

**æ³¨å†Œä¸º UTCP å·¥å…·**ï¼š
```go
err := agent.RegisterAsUTCPProvider(ctx, utcpClient, "local.analyst", "Analyzes data")
```

**è°ƒç”¨ UTCP å·¥å…·**ï¼š
```go
result, err := utcpClient.CallTool(ctx, "local.analyst", map[string]any{
    "instruction": "Analyze Q4 sales",
})
```

#### CodeMode æ¨¡å¼

CodeMode å…è®¸ LLM ç”Ÿæˆ Go ä»£ç æ¥è°ƒç”¨å·¥å…·ï¼Œå®ç°æ›´çµæ´»çš„å·¥å…·ç¼–æ’ï¼š

```go
kit, err := adk.New(ctx,
    adk.WithCodeModeUtcp(utcpClient, model), // å¯ç”¨ CodeMode
)
```

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·: "åˆ†æ Q4 é”€å”®æ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š"
    â†“
LLM ç”Ÿæˆä»£ç :
    analysis, _ := codemode.CallTool("local.analyst", map[string]any{
        "instruction": "Analyze Q4 sales",
    })
    report, _ := codemode.CallTool("local.writer", map[string]any{
        "instruction": fmt.Sprintf("Create report: %v", analysis),
    })
    __out = report
    â†“
CodeMode æ‰§è¡Œç”Ÿæˆçš„ä»£ç 
    â†“
è¿”å›ç»“æœ
```

---

### 6. SubAgents æ¨¡å— (å­æ™ºèƒ½ä½“)

**ä½ç½®**: `src/subagents/`

#### SubAgent æ¥å£

```go
type SubAgent interface {
    Name() string
    Description() string
    Run(ctx context.Context, input string) (string, error)
}
```

#### å†…ç½®å­æ™ºèƒ½ä½“

##### Researcher (ç ”ç©¶å‘˜)

**æ–‡ä»¶**: `src/subagents/researcher.go`

**èŒè´£**ï¼š
- ç»¼åˆèƒŒæ™¯ä¿¡æ¯
- èµ·è‰ç ”ç©¶æ‘˜è¦
- æä¾›ç»“æ„åŒ–è°ƒæŸ¥ç»“æœ

**å®ç°**ï¼š
```go
type Researcher struct {
    model   models.Agent
    persona string
}

func (r *Researcher) Run(ctx context.Context, input string) (string, error) {
    prompt := r.persona + "\n\nTask:\n" + input
    resp, err := r.model.Generate(ctx, prompt)
    return fmt.Sprint(resp), err
}
```

#### å­æ™ºèƒ½ä½“ç›®å½•

```go
directory := agent.NewStaticSubAgentDirectory([]agent.SubAgent{
    researcher,
    writer,
    reviewer,
})

// æŸ¥æ‰¾å­æ™ºèƒ½ä½“
subAgent, found := directory.Lookup("researcher")

// è¿è¡Œå­æ™ºèƒ½ä½“
result, err := subAgent.Run(ctx, "Research quantum computing")
```

---

### 7. Swarm æ¨¡å— (ç¾¤ä½“ååŒ)

**ä½ç½®**: `src/swarm/`

#### æ ¸å¿ƒæ¦‚å¿µ

Swarm æä¾›å¤šæ™ºèƒ½ä½“ååŒå·¥ä½œçš„æ¡†æ¶ï¼š
- å‚ä¸è€…ç®¡ç†
- å…±äº«è®°å¿†ç©ºé—´
- è§’è‰²æƒé™æ§åˆ¶

#### æ ¸å¿ƒç»“æ„

```go
type Swarm struct {
    *Participants
}

type Participant struct {
    ID          string
    Agent       *agent.Agent
    SharedSpace *memory.SharedSession
    JoinedSpaces []string
}
```

#### ä¸»è¦åŠŸèƒ½

1. **å‚ä¸è€…ç®¡ç†**ï¼š
   ```go
   swarm := swarm.NewSwarm(participants)
   participant := swarm.GetParticipant("agent-1")
   ```

2. **ç©ºé—´ç®¡ç†**ï¼š
   ```go
   // åŠ å…¥å…±äº«ç©ºé—´
   swarm.Join("agent-1", "project-alpha")
   
   // ç¦»å¼€ç©ºé—´
   swarm.Leave("agent-1", "project-alpha")
   ```

3. **è®°å¿†åŒæ­¥**ï¼š
   ```go
   // ä¿å­˜æ‰€æœ‰å‚ä¸è€…è®°å¿†
   swarm.Save(ctx)
   
   // æ£€ç´¢å‚ä¸è€…è®°å¿†
   memories, err := swarm.Retrieve(ctx, "agent-1")
   ```

---

### 8. Cache æ¨¡å— (ç¼“å­˜å±‚)

**ä½ç½®**: `src/cache/`

#### LRU Cache

**æ–‡ä»¶**: `src/cache/lru_cache.go`

**ç‰¹æ€§**ï¼š
- å›ºå®šå®¹é‡çš„ LRU (Least Recently Used) ç¼“å­˜
- çº¿ç¨‹å®‰å…¨
- O(1) è®¿é—®å’Œæ›´æ–°
- æ”¯æŒæ³›å‹

**å®ç°**ï¼š
```go
type LRUCache[K comparable, V any] struct {
    capacity int
    items    map[K]*list.Element
    order    *list.List
    mu       sync.RWMutex
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- MIME ç±»å‹è§„èŒƒåŒ–ç¼“å­˜ (10-50x æ€§èƒ½æå‡)
- å·¥å…·è§„èŒƒç¼“å­˜
- åµŒå…¥å‘é‡ç¼“å­˜
- æç¤ºè¯æ¨¡æ¿ç¼“å­˜

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```go
cache := cache.NewLRUCache[string, string](1000)
// cache.NewLRUCache[string, string](1000) è¿™ä¸ªæ˜¯ä»€ä¹ˆè¯­æ³•? è¿™æ˜¯ Go 1.18 å¼•å…¥çš„æ³›å‹è¯­æ³•ï¼Œè¡¨ç¤ºåˆ›å»ºä¸€ä¸ªé”®ç±»å‹ä¸º stringï¼Œå€¼ç±»å‹ä¸º string çš„ LRUCache å®ä¾‹ï¼Œå®¹é‡ä¸º 1000ã€‚
cache.Put("key", "value")
value, found := cache.Get("key")
```

---

### 9. Concurrent æ¨¡å— (å¹¶å‘å·¥å…·)

**ä½ç½®**: `src/concurrent/`

#### Worker Pool

**æ–‡ä»¶**: `src/concurrent/pool.go`

**ç‰¹æ€§**ï¼š
- å›ºå®šå¤§å°çš„å·¥ä½œæ± 
- å¹¶å‘ä»»åŠ¡æ‰§è¡Œ
- é”™è¯¯èšåˆ
- ä¼˜é›…å…³é—­

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ‰¹é‡åµŒå…¥ç”Ÿæˆ
- å¹¶è¡Œå·¥å…·è°ƒç”¨
- æ‰¹é‡è®°å¿†æ£€ç´¢

---

## æ¨¡å—é—´åä½œå…³ç³»

### ä¾èµ–å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Application                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent (Core)                          â”‚
â”‚  ä¾èµ–: Models, Memory, Tools, SubAgents, UTCP          â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚        â”‚        â”‚        â”‚        â”‚
    â†“        â†“        â†“        â†“        â†“
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Modelsâ”‚ â”‚Memoryâ”‚ â”‚Tools â”‚ â”‚SubAgentâ”‚ â”‚ UTCP â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
   â”‚        â”‚                   â”‚
   â”‚        â†“                   â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
   â”‚   â”‚   Engine   â”‚          â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
   â”‚         â”‚                  â”‚
   â”‚         â†“                  â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
   â”‚   â”‚VectorStore â”‚          â”‚
   â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
   â”‚         â”‚                  â”‚
   â”‚         â†“                  â”‚
   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
   â”‚   â”‚  Embedder  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”¤            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¤äº’æµç¨‹

#### åœºæ™¯ 1: ç”¨æˆ·æŸ¥è¯¢å¤„ç†

```
ç”¨æˆ·
 â”‚
 â”œâ”€â”€â†’ Agent.Generate()
      â”‚
      â”œâ”€â”€â†’ Memory.Retrieve()  (æ£€ç´¢ç›¸å…³è®°å¿†)
      â”‚    â”‚
      â”‚    â””â”€â”€â†’ Engine.Retrieve()
      â”‚         â”‚
      â”‚         â””â”€â”€â†’ VectorStore.SearchMemory()
      â”‚
      â”œâ”€â”€â†’ Models.Generate()  (LLM ç”Ÿæˆå“åº”)
      â”‚
      â”œâ”€â”€â†’ è§£æå·¥å…·è°ƒç”¨
      â”‚
      â”œâ”€â”€â†’ ToolCatalog.Lookup()  (æŸ¥æ‰¾å·¥å…·)
      â”‚
      â”œâ”€â”€â†’ Tool.Invoke()  (æ‰§è¡Œå·¥å…·)
      â”‚
      â”œâ”€â”€â†’ Memory.Store()  (å­˜å‚¨æ–°è®°å¿†)
      â”‚    â”‚
      â”‚    â””â”€â”€â†’ Engine.Store()
      â”‚         â”‚
      â”‚         â””â”€â”€â†’ VectorStore.StoreMemory()
      â”‚
      â””â”€â”€â†’ è¿”å›å“åº”
```

#### åœºæ™¯ 2: å¤šæ™ºèƒ½ä½“ååŒ

```
ä¸» Agent
 â”‚
 â”œâ”€â”€â†’ SubAgentDirectory.Lookup("researcher")
 â”‚    â”‚
 â”‚    â””â”€â”€â†’ è¿”å› Researcher SubAgent
 â”‚
 â”œâ”€â”€â†’ SubAgent.Run()
 â”‚    â”‚
 â”‚    â””â”€â”€â†’ Models.Generate()
 â”‚
 â”œâ”€â”€â†’ æ•´åˆç»“æœ
 â”‚
 â””â”€â”€â†’ Memory.Store()  (å­˜å‚¨åˆ°å…±äº«ç©ºé—´)
      â”‚
      â””â”€â”€â†’ å…¶ä»– Agent å¯è®¿é—®
```

#### åœºæ™¯ 3: CodeMode å·¥å…·ç¼–æ’

```
ç”¨æˆ·è¾“å…¥
 â”‚
 â”œâ”€â”€â†’ CodeMode Agent
 â”‚    â”‚
 â”‚    â”œâ”€â”€â†’ Models.Generate()  (ç”Ÿæˆ Go ä»£ç )
 â”‚    â”‚
 â”‚    â””â”€â”€â†’ CodeMode.Execute()
 â”‚         â”‚
 â”‚         â”œâ”€â”€â†’ UTCPClient.CallTool("tool1")
 â”‚         â”‚    â”‚
 â”‚         â”‚    â””â”€â”€â†’ Agent1.Generate()
 â”‚         â”‚
 â”‚         â”œâ”€â”€â†’ UTCPClient.CallTool("tool2")
 â”‚         â”‚    â”‚
 â”‚         â”‚    â””â”€â”€â†’ Agent2.Generate()
 â”‚         â”‚
 â”‚         â””â”€â”€â†’ è¿”å›èšåˆç»“æœ
 â”‚
 â””â”€â”€â†’ è¿”å›æœ€ç»ˆè¾“å‡º
```

---

## å…³é”®æµç¨‹åˆ†æ

### æµç¨‹ 1: Agent åˆå§‹åŒ–

```go
// 1. åˆ›å»ºä¾èµ–ç»„ä»¶
model, _ := models.NewGeminiLLM(ctx, "gemini-2.5-pro", "You are helpful")
store := memory.NewInMemoryStore()
engine := memory.NewEngine(store, memory.DefaultOptions())
memoryBank := memory.NewMemoryBankWithStore(store, engine)
sessionMemory := memory.NewSessionMemory(memoryBank)

// 2. å‡†å¤‡å·¥å…·å’Œå­æ™ºèƒ½ä½“
tools := []agent.Tool{echoTool, calcTool}
subAgents := []agent.SubAgent{researcher}

// 3. åˆ›å»º Agent
agent, err := agent.New(agent.Options{
    Model:        model,
    Memory:       sessionMemory,
    SystemPrompt: "You are a helpful assistant",
    ContextLimit: 10,
    Tools:        tools,
    SubAgents:    subAgents,
})

// 4. (å¯é€‰) æ³¨å†Œä¸º UTCP å·¥å…·
utcpClient := utcp.NewClient()
agent.RegisterAsUTCPProvider(ctx, utcpClient, "local.assistant", "AI assistant")
```

### æµç¨‹ 2: å¯¹è¯ç”Ÿæˆè¯¦è§£

```go
response, err := agent.Generate(ctx, "session-123", "è®¡ç®— 42 * 17")
```

**å†…éƒ¨æ­¥éª¤**ï¼š

1. **è®°å¿†æ£€ç´¢** (RAG):
   ```go
   // åµŒå…¥ç”¨æˆ·æŸ¥è¯¢
   queryEmbedding := embedder.Embed(ctx, "è®¡ç®— 42 * 17")
   
   // æ£€ç´¢ç›¸å…³è®°å¿†
   memories := engine.Retrieve(ctx, "session-123", queryEmbedding, 5)
   // è¿”å›: [
   //   {content: "ç”¨æˆ·ä¹‹å‰é—®è¿‡ä¹˜æ³•", similarity: 0.85},
   //   {content: "ç”¨æˆ·å–œæ¬¢æ•°å­¦", similarity: 0.72},
   // ]
   ```

2. **æ„å»ºä¸Šä¸‹æ–‡**:
   ```go
   prompt := buildPrompt(
       systemPrompt,    // "You are a helpful assistant"
       memories,        // ç›¸å…³è®°å¿†
       userQuery,       // "è®¡ç®— 42 * 17"
       toolSpecs,       // å¯ç”¨å·¥å…·åˆ—è¡¨
   )
   // ç»“æœç¤ºä¾‹:
   // """
   // System: You are a helpful assistant
   // 
   // Memory:
   // - User previously asked about multiplication
   // 
   // Available Tools:
   // - calculator: Performs basic math operations
   // 
   // User: è®¡ç®— 42 * 17
   // """
   ```

3. **LLM ç”Ÿæˆ**:
   ```go
   response := model.Generate(ctx, prompt)
   // LLM å¯èƒ½è¿”å›:
   // "I'll use the calculator tool: 
   //  {"tool": "calculator", "arguments": {"a": 42, "b": 17, "op": "multiply"}}"
   ```

4. **è§£æå·¥å…·è°ƒç”¨**:
   ```go
   toolCalls := parseToolCalls(response)
   // [
   //   {name: "calculator", args: {a: 42, b: 17, op: "multiply"}}
   // ]
   ```

5. **æ‰§è¡Œå·¥å…·**:
   ```go
   tool, spec, _ := toolCatalog.Lookup("calculator")
   result, _ := tool.Invoke(ctx, ToolRequest{
       SessionID: "session-123",
       Arguments: {a: 42, b: 17, op: "multiply"},
   })
   // result.Content = "714"
   ```

6. **åˆå¹¶ç»“æœ**:
   ```go
   finalPrompt := prompt + "\n\nTool result: 714\n\nProvide final answer:"
   finalResponse := model.Generate(ctx, finalPrompt)
   // "42 * 17 = 714"
   ```

7. **å­˜å‚¨è®°å¿†**:
   ```go
   memory.Store(ctx, "session-123", 
       "User asked: è®¡ç®— 42 * 17. Answer: 714",
       map[string]any{"importance": 0.6})
   ```

### æµç¨‹ 3: è®°å¿†æ£€ç´¢ä¸è¯„åˆ†

```go
memories, err := engine.Retrieve(ctx, "session-123", queryEmbedding, 10)
```

**è¯¦ç»†æ­¥éª¤**ï¼š

1. **å‘é‡æ£€ç´¢**:
   ```go
   candidates := vectorStore.SearchMemory(ctx, "session-123", queryEmbedding, 50)
   // è¿”å›å‰ 50 ä¸ªè¯­ä¹‰ç›¸ä¼¼çš„è®°å¿†
   ```

2. **ç»¼åˆè¯„åˆ†**:
   ```go
   for each candidate:
       // è¯­ä¹‰ç›¸ä¼¼åº¦ (0-1)
       semanticScore := cosineSimilarity(queryEmbedding, candidate.Embedding)
       
       // æ—¶é—´è¡°å‡
       age := now - candidate.CreatedAt
       timeScore := exp(-decayRate * age)
       
       // é‡è¦æ€§
       importanceScore := candidate.Importance
       
       // ç»¼åˆè¯„åˆ†
       finalScore := 
           weights.Semantic * semanticScore +
           weights.Temporal * timeScore +
           weights.Importance * importanceScore
   ```

3. **MMR å»é‡**:
   ```go
   // Maximum Marginal Relevance
   selected := []Memory{}
   while len(selected) < limit:
       best := argmax(
           Î» * relevance(m) - (1-Î») * max_similarity(m, selected)
       )
       selected.append(best)
   ```

4. **è¿”å›ç»“æœ**:
   ```go
   return selected.sortBy(score).limit(10)
   ```

### æµç¨‹ 4: å­æ™ºèƒ½ä½“å§”æ´¾

```go
// ä¸» Agent å§”æ´¾ç»™ Researcher
result, err := agent.Generate(ctx, "session-123", 
    "Research the latest trends in quantum computing")
```

**å¤„ç†æµç¨‹**ï¼š

1. **è¯†åˆ«å§”æ´¾æ„å›¾**:
   ```go
   // LLM åˆ†æç”¨æˆ·è¯·æ±‚
   if needsSubAgent(query):
       subAgentName = selectSubAgent(query, subAgentDirectory.All())
       // è¿”å›: "researcher"
   ```

2. **æŸ¥æ‰¾å­æ™ºèƒ½ä½“**:
   ```go
   subAgent, found := subAgentDirectory.Lookup("researcher")
   ```

3. **å§”æ´¾æ‰§è¡Œ**:
   ```go
   result, err := subAgent.Run(ctx, 
       "Research the latest trends in quantum computing")
   // Researcher å†…éƒ¨:
   // 1. æ„å»ºä¸“ä¸šæç¤ºè¯
   // 2. è°ƒç”¨è‡ªå·±çš„ LLM
   // 3. è¿”å›ç»“æ„åŒ–ç»“æœ
   ```

4. **æ•´åˆç»“æœ**:
   ```go
   finalResponse := integrateSubAgentResult(
       originalQuery,
       subAgentResult,
       mainAgentContext,
   )
   ```

### æµç¨‹ 5: Checkpoint ä¸ Restore

```go
// ä¿å­˜çŠ¶æ€
data, err := agent.Checkpoint()
os.WriteFile("agent-state.json", data, 0644)

// æ¢å¤çŠ¶æ€
data, _ := os.ReadFile("agent-state.json")
newAgent, _ := agent.New(opts)
newAgent.Restore(data)
```

**Checkpoint åŒ…å«**ï¼š
```json
{
  "system_prompt": "You are a helpful assistant",
  "short_term": {
    "session-123": [
      {
        "content": "Previous conversation...",
        "embedding": [0.1, 0.2, ...],
        "importance": 0.8,
        "created_at": "2026-02-14T10:00:00Z"
      }
    ]
  },
  "joined_spaces": ["project-alpha", "team-beta"],
  "timestamp": "2026-02-14T12:00:00Z"
}
```

**åº”ç”¨åœºæ™¯**ï¼š
- è·¨è¿›ç¨‹/æœåŠ¡å™¨è¿ç§»
- çƒ­é‡å¯ä¿æŒçŠ¶æ€
- ç‰ˆæœ¬å›æ»š
- è°ƒè¯•å’Œå®¡è®¡

---

## æŠ€æœ¯æ ˆä¸ä¾èµ–

### æ ¸å¿ƒä¾èµ–

```
Go 1.25+
â”‚
â”œâ”€â”€ LLM SDKs
â”‚   â”œâ”€â”€ google/generative-ai-go (Gemini)
â”‚   â”œâ”€â”€ anthropics/anthropic-sdk-go (Claude)
â”‚   â”œâ”€â”€ ollama/ollama (æœ¬åœ°æ¨¡å‹)
â”‚   â””â”€â”€ sashabaranov/go-openai (OpenAI)
â”‚
â”œâ”€â”€ å‘é‡å­˜å‚¨
â”‚   â”œâ”€â”€ jackc/pgx/v5 (PostgreSQL)
â”‚   â”œâ”€â”€ qdrant (Qdrant å®¢æˆ·ç«¯)
â”‚   â”œâ”€â”€ neo4j/neo4j-go-driver/v5 (Neo4j)
â”‚   â””â”€â”€ go.mongodb.org/mongo-driver (MongoDB)
â”‚
â”œâ”€â”€ åµŒå…¥æ¨¡å‹
â”‚   â”œâ”€â”€ anush008/fastembed-go (FastEmbed)
â”‚   â””â”€â”€ (é›†æˆå„ LLM SDK çš„åµŒå…¥ API)
â”‚
â”œâ”€â”€ UTCP
â”‚   â””â”€â”€ universal-tool-calling-protocol/go-utcp
â”‚
â””â”€â”€ å·¥å…·åº“
    â”œâ”€â”€ alpkeskin/gotoon (ASCII åŠ¨ç”»)
    â””â”€â”€ google/uuid (UUID ç”Ÿæˆ)
```

### æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

1. **LRU ç¼“å­˜**: 184 ns/op ç¼“å­˜æ“ä½œ
2. **é¢„åˆ†é…ç¼“å†²åŒº**: å‡å°‘ 40-60% å†…å­˜åˆ†é…
3. **å¹¶å‘å·¥ä½œæ± **: å¹¶è¡Œå¤„ç†æ‰¹é‡ä»»åŠ¡
4. **MIME è§„èŒƒåŒ–ç¼“å­˜**: 10-50x æ€§èƒ½æå‡
5. **å­—ç¬¦ä¸²æ“ä½œä¼˜åŒ–**: å‡å°‘ 30-50% å¼€é”€

### ç¯å¢ƒå˜é‡é…ç½®

| å˜é‡ | è¯´æ˜ | å¿…éœ€ |
|------|------|------|
| `GOOGLE_API_KEY` | Gemini API å¯†é’¥ | ä½¿ç”¨ Gemini æ—¶ |
| `ANTHROPIC_API_KEY` | Claude API å¯†é’¥ | ä½¿ç”¨ Claude æ—¶ |
| `OPENAI_API_KEY` | OpenAI API å¯†é’¥ | ä½¿ç”¨ OpenAI æ—¶ |
| `DATABASE_URL` | PostgreSQL è¿æ¥å­—ç¬¦ä¸² | ä½¿ç”¨ PostgreSQL å­˜å‚¨æ—¶ |
| `QDRANT_URL` | Qdrant æœåŠ¡åœ°å€ | ä½¿ç”¨ Qdrant æ—¶ |
| `ADK_EMBED_PROVIDER` | åµŒå…¥æä¾›å•† (gemini/openai/ollama) | å¦ |
| `NEO4J_URI` | Neo4j è¿æ¥ URI | ä½¿ç”¨ Neo4j æ—¶ |
| `MONGODB_URI` | MongoDB è¿æ¥ URI | ä½¿ç”¨ MongoDB æ—¶ |

### é¡¹ç›®ç‰¹è‰²

1. **ç”Ÿäº§çº§è®¾è®¡**:
   - å®Œå–„çš„é”™è¯¯å¤„ç†
   - å¹¶å‘å®‰å…¨
   - èµ„æºç®¡ç†ï¼ˆcontext å–æ¶ˆã€è¶…æ—¶ï¼‰
   - æ€§èƒ½åŸºå‡†æµ‹è¯•

2. **å¯æµ‹è¯•æ€§**:
   - æ¥å£é©±åŠ¨è®¾è®¡
   - Mock å‹å¥½
   - å•å…ƒæµ‹è¯•è¦†ç›–
   - é›†æˆæµ‹è¯•ç¤ºä¾‹

3. **æ‰©å±•æ€§**:
   - æ’ä»¶å¼æ¨¡å—ç³»ç»Ÿ
   - è‡ªå®šä¹‰ Provider
   - å¯æ›¿æ¢ç»„ä»¶

4. **å¼€å‘è€…ä½“éªŒ**:
   - æ¸…æ™°çš„ API
   - ä¸°å¯Œçš„ç¤ºä¾‹ (cmd/example/)
   - è¯¦ç»†çš„æ³¨é‡Š
   - ç±»å‹å®‰å…¨

---

## æ€»ç»“

Go-Agent (Lattice) æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾è‰¯ã€åŠŸèƒ½å®Œå–„çš„ AI æ™ºèƒ½ä½“æ¡†æ¶ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

âœ… **æ¨¡å—åŒ–ä¸å¯ç»„åˆæ€§**ï¼šé€šè¿‡ ADK å’Œ Module ç³»ç»Ÿå®ç°çµæ´»çš„ç»„ä»¶ç»„è£…  
âœ… **ç”Ÿäº§å°±ç»ª**ï¼šå†…ç½®æ€§èƒ½ä¼˜åŒ–ã€é”™è¯¯å¤„ç†ã€å¹¶å‘å®‰å…¨  
âœ… **å¤šæ¨¡å‹æ”¯æŒ**ï¼šç»Ÿä¸€æ¥å£é€‚é…å¤šç§ LLM æä¾›å•†  
âœ… **æ™ºèƒ½è®°å¿†ç³»ç»Ÿ**ï¼šåŸºäº RAG çš„è¯­ä¹‰æ£€ç´¢å’Œæ™ºèƒ½è¯„åˆ†  
âœ… **ä¸°å¯Œçš„å·¥å…·ç”Ÿæ€**ï¼šUTCP åè®®æ”¯æŒå’Œ CodeMode ç¼–æ’  
âœ… **å¤šæ™ºèƒ½ä½“ååŒ**ï¼šSubAgent å’Œ Swarm æ”¯æŒå¤æ‚å·¥ä½œæµ  

è¯¥æ¡†æ¶é€‚åˆæ„å»ºä»ç®€å•èŠå¤©æœºå™¨äººåˆ°å¤æ‚å¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å„ç±» AI åº”ç”¨ã€‚
